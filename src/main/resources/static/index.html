<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–ç»¼åˆæ§åˆ¶å°</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4edr;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-sub: #475569;
            --radius: 8px;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
            /* === æ—¥å¿—ä¼˜åŒ–åçš„å˜é‡ === */
            --log-bg-dark: #1f2937; /* æ·±è‰²èƒŒæ™¯ */
            --log-text-main: #e5e7eb; /* æµ…è‰²ä¸»æ–‡æœ¬ */
            --log-info: #60a5fa;      /* è“è‰²ä¿¡æ¯ */
            --log-data: #ffc107;      /* æ–°å¢ï¼šé»„è‰²/ç¥ç€è‰²æ•°æ® */
            --log-time: #9ca3af;      /* ç°è‰²æ—¶é—´ */
            --log-error: #f87171;     /* æ–°å¢ï¼šçº¢è‰²é”™è¯¯ */ /* å¯¹åº” --danger */

            /* ä¿ç•™ä½†ä¸å†ä½¿ç”¨çš„æ—§çº§åˆ«é¢œè‰² */
            --log-success: #34d399;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-sub);
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* é€šç”¨å¡ç‰‡ä¸è¡¨å• */
        .card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section-title {
            margin-top: 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.25rem;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95rem;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* æŒ‰é’® */
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
            font-size: 0.95rem;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-warning { background-color: var(--warning); color: #fff; }

        /* æ­¥éª¤åˆ—è¡¨æ ·å¼ */
        .step-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: box-shadow 0.2s, opacity 0.2s;
        }
        .step-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* æ‹–æ‹½æ—¶æ ·å¼ */
        .step-card.dragging {
            opacity: 0.5;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* æ‹–æ”¾ç›®æ ‡æŒ‡ç¤ºçº¿ */
        .drag-over-indicator {
            height: 4px;
            background: var(--primary);
            margin: 5px 0;
            border-radius: 2px;
            opacity: 0.7;
            transition: height 0.1s;
        }

        /* ä¿®æ­£ï¼šstep-header å¯æ‹–æ‹½ */
        .step-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px;
            cursor: grab; /* æ‹–æ‹½æŒ‡ç¤º */
        }
        .step-badge {
            background: #dbeafe; color: #1e40af; padding: 2px 8px;
            border-radius: 4px; font-weight: bold; margin-right: 10px;
        }

        /* åµŒå¥—åŒºåŸŸ */
        .nested-area {
            margin-top: 15px; padding: 15px; background: #fff;
            border-left: 3px solid var(--primary); border-radius: 0 6px 6px 0;
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); border-right: 1px solid var(--border);
        }

        /* æºç é¢„è§ˆåŒº */
        #codePreview {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 20px;
            border-radius: var(--radius);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            min-height: 300px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .code-actions {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding: 10px 15px;
            background: #f8fafc; border-radius: var(--radius); border: 1px solid var(--border);
        }

        /* WebSocket çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .ws-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        .ws-status.connected { background: var(--success); color: white; }
        .ws-status.disconnected { background: var(--danger); color: white; }
        .ws-status.connecting { background: var(--warning); color: white; }

        /* Toast */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px;
            border-radius: 8px; color: white; z-index: 2000; display: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 500;
        }

        /* ================= æ—¥å¿—ä¼˜åŒ–æ ·å¼ (æ–°å¸ƒå±€) ================= */

        .log-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 380px);
        }

        /* è°ƒæ•´æ§åˆ¶åŒºå¸ƒå±€ */
        .log-controls {
            /* è°ƒæ•´ä¸ºå‚ç›´æµï¼Œä»¥å®¹çº³ç»Ÿè®¡ä¿¡æ¯å’Œæ§åˆ¶é¡¹ */
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .log-stats {
            /* ä¼˜åŒ–ç‚¹1: å°†ç»Ÿè®¡ä¿¡æ¯å‹ç¼©åˆ°ä¸€è¡Œ */
            display: flex;
            gap: 15px;
            font-size: 0.8rem; /* ç°è‰²å°å­— */
            color: var(--text-sub);
            font-weight: 500;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }

        .log-filters-actions-row {
            /* ä¼˜åŒ–ç‚¹2: ç­›é€‰å’Œæ“ä½œæŒ‰é’®åœ¨åŒä¸€è¡Œ */
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .log-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end; /* åº•éƒ¨å¯¹é½ */
        }

        .log-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .log-controls .form-group {
            margin-bottom: 0;
            min-width: 150px;
        }

        .log-content {
            flex: 1;
            background-color: var(--log-bg-dark);
            color: var(--log-text-main);
            padding: 15px;
            border-radius: var(--radius);
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        /* æ—¥å¿—æ¡ç›®æ ·å¼ */
        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
            line-height: 1.4;
            display: flex;
            gap: 10px;
        }

        .log-entry .time {
            color: var(--log-time);
            flex-shrink: 0;
        }

        .log-level-badge {
            font-weight: bold;
            flex-shrink: 0;
            padding: 0 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            line-height: 1.5;
        }

        .log-entry.info .log-level-badge { background: var(--log-info); color: var(--log-bg-dark); }
        .log-entry.data .log-level-badge { background: var(--log-data); color: var(--text-main); }
        .log-entry.error .log-level-badge { background: var(--log-error); color: white; } /* æ–°å¢ ERROR æ ·å¼ */


        .log-message {
            flex-grow: 1;
        }

        /* æ–‡æ¡£åŒºåŸŸæ ·å¼ */
        .docs-content h2 {
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
            margin-top: 30px;
            color: var(--primary);
        }
        .docs-content h3 {
            color: var(--text-main);
            margin-top: 20px;
        }
        .docs-content ul {
            list-style: disc;
            padding-left: 20px;
        }
        .docs-content li {
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .docs-content code {
            background-color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-weight: 600;
            color: var(--primary);
        }
        .docs-content blockquote {
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
            padding: 10px 15px;
            margin: 15px 0;
            color: var(--text-sub);
            font-style: italic;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1000px) {
            .log-filters-actions-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .log-filters {
                flex-wrap: wrap;
            }
        }

    </style>
</head>
<body>

<div class="container">

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('editor')">ğŸ› ï¸ æµç¨‹ç¼–æ’</button>
        <button class="tab-btn" onclick="switchTab('cookie')">ğŸª å¯¼å‡º Cookie</button>
        <button class="tab-btn" onclick="switchTab('codegen')">ğŸ’» ä»£ç ç”Ÿæˆ</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“Š ç³»ç»Ÿæ—¥å¿—</button>
        <button class="tab-btn" onclick="switchTab('docs')">ğŸ“– ä½¿ç”¨æ–‡æ¡£</button>
    </div>

    <div id="tab-editor" class="tab-content active">
        <div class="card">
            <h3 class="section-title">
                å…¨å±€é…ç½®
                <span style="font-size: 0.9rem; font-weight: normal; color: var(--text-sub);">
                    å®šä¹‰è‡ªåŠ¨åŒ–çš„èµ·å§‹ç‚¹
                    <span id="wsStatus" class="ws-status disconnected">ğŸ”´ æœªè¿æ¥</span>
                </span>
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>ğŸŒ èµ·å§‹ URL</label>
                    <input type="text" id="rootUrl" placeholder="https://example.com" />
                </div>
                <div class="form-group">
                    <label>ğŸ’¾ å¯¼å‡ºæ–‡ä»¶å (ä¸å«åç¼€)</label>
                    <input type="text" id="exportFileName" placeholder="ä¾‹å¦‚ï¼šmy_task (é»˜è®¤ä¸ºæ—¶é—´æˆ³)" />
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="triggerImport()">ğŸ“‚ å¯¼å…¥ JSON</button>
                    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(this)">
                    <button class="btn btn-secondary" onclick="exportJson()">ğŸ’¾ å¯¼å‡º JSON</button>
                </div>
            </div>
        </div>

        <div id="stepsContainer"></div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn btn-success" onclick="addRootStep()">+ æ·»åŠ æ­¥éª¤</button>
        </div>

        <div class="card" style="position: sticky; bottom: 0; border-top: 4px solid var(--primary); z-index: 10;">
            <div class="btn-row" style="justify-content: flex-end;">
                <button class="btn btn-primary" onclick="validateSteps()">ğŸ” æ ¡éªŒæ­¥éª¤</button>
                <button class="btn btn-danger" onclick="executeSteps()">ğŸš€ æ‰§è¡Œä»»åŠ¡</button>
            </div>
        </div>
    </div>

    <div id="tab-docs" class="tab-content">
        <div class="card docs-content">
            <h2 style="margin-top: 0;">ğŸ“• ä¸€ä¸ªéå¸¸éå¸¸ç®€æ˜“çš„ä½¿ç”¨æ–‡æ¡£</h2>

            <blockquote>
                æœ¬é¡¹ç›®ä¸“æ³¨äºè‡ªåŠ¨åŒ–ä»»åŠ¡æ‰§è¡Œï¼Œå¸®åŠ©ç”¨æˆ·é€šè¿‡å¯è§†åŒ–çš„æ–¹å¼å®šä¹‰å¤æ‚çš„ç½‘é¡µäº¤äº’æ“ä½œï¼Œé›¶ä»£ç å®ç°è‡ªåŠ¨åŒ–ã€‚
            </blockquote>

            <h3>ä¸€ã€ XPath çš„è·å–</h3>
            <ul>
                <li>XPathæ˜¯ Web å…ƒç´ åœ¨é¡µé¢ä¸­çš„å”¯ä¸€è·¯å¾„ï¼Œæ˜¯è‡ªåŠ¨åŒ–æ“ä½œçš„åŸºç¡€ã€‚</li>
                <li>å¦‚ä½•è·å–ï¼š
                    <ol>
                        <li>ä½¿ç”¨ F12 å¿«æ·é”®è¿›å…¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·ã€‚</li>
                        <li>ç‚¹å‡»å¼€å‘è€…å·¥å…·å·¦ä¸Šè§’çš„ â€œé€‰æ‹©å…ƒç´ â€ æŒ‰é’®ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¸¦ç®­å¤´çš„æ–¹å—å›¾æ ‡ï¼‰ã€‚</li>
                        <li>åœ¨é¡µé¢ä¸Šç‚¹å‡»éœ€è¦å®šä½çš„å…ƒç´ ï¼Œå¼€å‘è€…å·¥å…·å°†è‡ªåŠ¨å®šä½åˆ°è¯¥å…ƒç´ çš„ HTML æ ‡ç­¾ã€‚</li>
                        <li>å³é”®ç‚¹å‡»è¯¥æ ‡ç­¾ï¼Œé€‰æ‹©â€œCopyâ€ -> â€œCopy full XPathâ€ å³å¯è·å¾—å®Œæ•´çš„ XPathã€‚</li>
                    </ol>
                </li>
            </ul>

            <h3>äºŒã€ æµç¨‹ç¼–æ’</h3>
            <ul>
                <li> æœ€ä½³å®è·µï¼š  åœ¨æ‰§è¡Œä»»åŠ¡å‰ï¼Œæœ€å¥½ç‚¹å‡»  â€œæ ¡éªŒæ­¥éª¤â€ ï¼Œç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µå‡å·²å¡«å†™ï¼Œé¿å…è¿è¡Œé”™è¯¯ã€‚</li>
                <li> ç­‰å¾…æ—¶é—´ï¼š  å»ºè®®åœ¨  ç¬¬ä¸€æ­¥æˆ–ä»»ä½•å¯èƒ½å¯¼è‡´é¡µé¢åŠ è½½çš„æ­¥éª¤ä¹‹åï¼Œè®¾ç½®ä¸€ä¸ªé€‚å½“çš„  â€œç­‰å¾…æ—¶é—´(ms)â€  (ä¾‹å¦‚ 1000ms æˆ–æ›´ä¹…)ï¼Œä»¥é˜²æ­¢å› é¡µé¢å“åº”è¿‡æ…¢è€Œæ‰¾ä¸åˆ°ç›®æ ‡æ ‡ç­¾ã€‚</li>
            </ul>

            <h3>ä¸‰ã€ å¾ªç¯æ“ä½œä¸å ä½ç¬¦</h3>
            <p>å¾ªç¯æ“ä½œï¼ˆå¦‚éå†ç‚¹å‡»ã€åŠ¨æ€å¾ªç¯ï¼‰æ˜¯å®ç°å¤æ‚ä»»åŠ¡çš„å…³é”®ã€‚å®ƒä»¬ä¾èµ–äºå ä½ç¬¦æ¥åŠ¨æ€æ”¹å˜ XPath </p>
            <ul>
                <li>
                    <h4>éå†æ“ä½œï¼ˆå¾ªç¯ç‚¹å‡» / å¾ªç¯è¾“å…¥ / å¾ªç¯è·å–å†…å®¹ï¼‰</h4>
                    <ul>
                        <li> é»˜è®¤å ä½ç¬¦ï¼š  æ”¯æŒä½¿ç”¨ `{i}` å’Œ `{index}`ã€‚</li>
                        <li> é»˜è®¤èµ·å§‹å€¼ï¼š  é»˜è®¤ä¸º  1 ã€‚</li>
                        <li> åº”ç”¨åœºæ™¯ï¼š  ä¸»è¦ç”¨äºæ“ä½œé¡µé¢ä¸ŠæŒ‰é¡ºåºæ’åˆ—çš„å…ƒç´ ï¼ŒXPathä¸­å¯ä»¥å†™ä½œï¼š<code>//div[@class="list"]/a[{index}]</code>ã€‚</li>
                    </ul>
                </li>
                <li>
                    <h4>åŠ¨æ€å¾ªç¯</h4>
                    <ul>
                        <li> é»˜è®¤å ä½ç¬¦ï¼š  æ”¯æŒä½¿ç”¨ `{i}` å’Œ `{index}`ã€‚</li>
                        <li> é»˜è®¤èµ·å§‹å€¼ï¼š  é»˜è®¤ä¸º  0 ã€‚</li>
                        <li> å¢é‡ï¼š  ä¸ºè¿™ä¸ªå ä½ç¬¦æ¯æ¬¡å¾ªç¯åå¢åŠ å¤šå°‘ ã€‚</li>
                        <li> è‡ªå®šä¹‰å ä½ç¬¦ï¼š   åŠ¨æ€å¾ªç¯å…è®¸æ‚¨è‡ªå®šä¹‰ä¸€ä¸ªå ä½ç¬¦åç§°ï¼ˆä¾‹å¦‚ï¼š`item_id`ï¼‰ï¼Œè¯¥å ä½ç¬¦çš„å€¼å°†å¯ä»¥è¢«å…¶æ‰€æœ‰å­ä»»åŠ¡å…±ç”¨ã€‚</li>
                        <li> å­ä»»åŠ¡æ”¯æŒï¼š  åŠ¨æ€å¾ªç¯çš„å­ä»»åŠ¡å¯ä»¥å®Œå…¨ä½¿ç”¨çˆ¶çº§å®šä¹‰çš„å ä½ç¬¦è¿›è¡Œ XPath å®šä½æˆ–å€¼è¾“å…¥ã€‚</li>
                    </ul>
                </li>
                <li>
                    <h4>å ä½ç¬¦è¡¨è¾¾å¼æ”¯æŒ</h4>
                    <p>å ä½ç¬¦ `{i}` å’Œ `{index}` å‡æ”¯æŒæ•°å­¦è¡¨è¾¾å¼è¿ç®—ï¼Œæå¤§æé«˜äº†ä»»åŠ¡ç¼–å†™çš„çµæ´»æ€§ã€‚</p>
                    <p><strong>æ ¼å¼ç¤ºä¾‹:</strong></p>
                    <pre><code>{index+1}</code>: ç´¢å¼•åŠ  1</pre>
                    <pre><code>{index-1}</code>: ç´¢å¼•å‡ 1</pre>
                    <pre><code>{index*3}</code>: ç´¢å¼•ä¹˜ä»¥ 3</pre>
                    <pre><code>{index*5+10}</code>: å¤æ‚çš„ä»£æ•°è¿ç®—</pre>
                    <p>æ‚¨å¯ä»¥æ ¹æ® XPath çš„æ•°å­—è§„å¾‹ï¼Œé€šè¿‡è¡¨è¾¾å¼æ¥å®šä½éè¿ç»­æˆ–æœ‰è§„å¾‹é—´éš”çš„å…ƒç´ ã€‚</p>
                </li>
            </ul>
        </div>
    </div>
    <div id="tab-cookie" class="tab-content">
        <div class="card">
            <h3 class="section-title">Cookie æå–å·¥å…·</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>ç›®æ ‡ç½‘å€ (URL) <span style="color:red">*</span></label>
                    <input type="text" id="cookieUrl" placeholder="https://..." />
                </div>
                <div class="form-group">
                    <label>ç­‰å¾…æ—¶é—´ (ç§’) <span style="color:red">*</span></label>
                    <input type="number" id="cookieWait" placeholder="ä¾‹å¦‚ï¼š30 (ç•™å‡ºè¶³å¤Ÿæ—¶é—´ç™»å½•)" />
                </div>
                <div class="form-group">
                    <label>å¯¼å‡ºæ–‡ä»¶è·¯å¾„ <span style="color:red">*</span></label>
                    <input type="text" id="cookiePath" placeholder="ä¾‹å¦‚ï¼šD:/cookies/site_a.txt" />
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="exportCookie()">ğŸ“¤ å¯åŠ¨æµè§ˆå™¨å¹¶å¯¼å‡º Cookie</button>
            </div>
        </div>
    </div>

    <div id="tab-codegen" class="tab-content">
        <div class="card">
            <h3 class="section-title">æºç ç”Ÿæˆå™¨</h3>
            <p style="color: var(--text-sub); margin-bottom: 5px;">åŸºäº"æµç¨‹ç¼–æ’"ä¸­çš„æ­¥éª¤ç”Ÿæˆå¯¹åº”çš„è‡ªåŠ¨åŒ–ä»£ç ã€‚</p>

            <p style="font-size: 0.85rem; color: var(--warning); margin-bottom: 20px; padding: 5px 10px; border-left: 3px solid var(--warning); background-color: #fefce8;">
                ğŸ’¡ æç¤ºï¼šç”Ÿæˆçš„ä»£ç ä¼šè‡ªå¸¦ä¸ºäº†æ”¯æŒæ‰€æœ‰æ“ä½œæ­¥éª¤å°è£…å¥½çš„ä¸€äº›æ–¹æ³•ã€‚**è¿™äº›å†—ä½™çš„æ–¹æ³•å¯ä»¥æ‰‹åŠ¨å»é™¤**ï¼Œä»¥ä¿æŒä»£ç çš„ç®€æ´æ€§ã€‚
            </p>
            <div class="form-grid">
                <div class="form-group">
                    <label>ç¼–ç¨‹è¯­è¨€</label>
                    <select id="codeLang">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç±»å / æ–‡ä»¶å</label>
                    <input type="text" id="codeClassName" value="AutoTask" placeholder="ä¾‹å¦‚ï¼šLoginTask" />
                </div>
                <div class="form-group">
                    <label>é€‰é¡¹</label>
                    <div style="margin-top: 10px;">
                        <input type="checkbox" id="codeComments" checked style="width: auto; margin-right: 5px;">
                        <span style="font-size: 0.9rem;">åŒ…å«æ³¨é‡Š</span>
                    </div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="generateCodePreview()">ğŸ‘ï¸ ç”Ÿæˆæºç é¢„è§ˆ</button>
                <button class="btn btn-success" onclick="downloadCode()" id="downloadBtn" disabled>ğŸ’¾ ä¸‹è½½æºç æ–‡ä»¶</button>
            </div>

            <div class="code-actions" id="codeActions" style="display: none;">
                <div class="code-info">
                    <span id="fileNameInfo">æ–‡ä»¶å: </span>
                    <span id="fileSizeInfo"> | å¤§å°: </span>
                    <span id="languageInfo"> | è¯­è¨€: </span>
                </div>
                <button class="btn btn-secondary" onclick="copyCode()" id="copyBtn">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>

            <div id="codePreview">è¯·å…ˆç”Ÿæˆæºç é¢„è§ˆ...</div>
        </div>
    </div>

    <div id="tab-logs" class="tab-content">
        <div class="card">
            <h3 class="section-title">
                ç³»ç»Ÿæ—¥å¿—
                <span style="font-size: 0.9rem; font-weight: normal; color: var(--text-sub);">
                    å®æ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—ä¸ç³»ç»ŸçŠ¶æ€
                    <span id="logWsStatus" class="ws-status disconnected">ğŸ”´ æœªè¿æ¥</span>
                </span>
            </h3>

            <div class="log-controls">
                <div class="log-stats">
                    <span id="logTotal">æ€»è®¡: 0 æ¡</span>
                    <span id="logInfo">ä¿¡æ¯ (INFO): 0 æ¡</span>
                    <span id="logData">æ•°æ® (DATA): 0 æ¡</span>
                    <span id="logError" style="color:var(--danger)">é”™è¯¯ (ERROR): 0 æ¡</span>
                </div>

                <div class="log-filters-actions-row">
                    <div class="log-filters">
                        <div class="form-group">
                            <label>æ—¥å¿—çº§åˆ«</label>
                            <select id="logLevelFilter">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="info">ä¿¡æ¯ (INFO)</option>
                                <option value="data">æ•°æ® (DATA)</option>
                                <option value="error">é”™è¯¯ (ERROR)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>æœç´¢å…³é”®è¯</label>
                            <input type="text" id="logSearch" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." />
                        </div>
                    </div>

                    <div class="log-actions">
                        <button class="btn btn-secondary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="btn btn-warning" onclick="reconnectWebSocket()">ğŸ”„ é‡è¿</button>
                        <button class="btn btn-primary" onclick="exportLogs()">ğŸ“¥ å¯¼å‡º</button>
                    </div>
                </div>
            </div>
            <div class="log-container">
                <div id="logContent" class="log-content">
                    <div class="log-entry info"><span class="time">00:00:00</span> <span class="log-level-badge">INFO</span> <span class="log-message">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤...</span></div>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="toast" class="toast"></div>

<script>
    // ================= WebSocket å®æ—¶æ—¥å¿— =================
    let logWebSocket = null;
    let isWebSocketConnected = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    const RECONNECT_INTERVAL = 3000;
    let reconnectTimer = null;

    function initWebSocket() {
        if (logWebSocket) {
            try {
                if (logWebSocket.readyState === WebSocket.OPEN || logWebSocket.readyState === WebSocket.CONNECTING) {
                    logWebSocket.close(1000, "Initiating new connection/Reconnecting");
                }
            } catch (e) {
                console.warn("Attempted to close potentially broken WebSocket:", e);
            }
            logWebSocket = null;
            isWebSocketConnected = false;
        }

        if (reconnectTimer !== null) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // const wsUrl = `${protocol}//${window.location.host}/ws/logs`; // ç”Ÿäº§ç¯å¢ƒ
        const wsUrl = `ws://localhost:8082/ws/logs`; // å¼€å‘/æµ‹è¯•ç¯å¢ƒ

        updateWebSocketStatus('connecting', 'ğŸŸ¡ è¿æ¥ä¸­...');

        try {
            logWebSocket = new WebSocket(wsUrl);

            logWebSocket.onopen = function(event) {
                isWebSocketConnected = true;
                reconnectAttempts = 0;
                updateWebSocketStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
                log('ğŸ”— WebSocket è¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æ¥æ”¶å®æ—¶æ—¥å¿—...', 'data');
                console.log('WebSocket connected to:', wsUrl);
            };

            logWebSocket.onmessage = function(event) {
                const logMessage = event.data;

                let message = logMessage;
                let level = 'info';

                // --- ä¿®å¤ç‚¹ï¼šåŸºäºåç«¯æ–°å‰ç¼€è¿›è¡Œè§£æï¼Œæ–°å¢ ERROR çº§åˆ« ---
                if (logMessage.startsWith('[INFO]')) {
                    level = 'info';
                    message = logMessage.substring(6).trim();
                } else if (logMessage.startsWith('[DATA]')) {
                    level = 'data';
                    message = logMessage.substring(6).trim();
                } else if (logMessage.startsWith('[ERROR]')) { // <-- æ–°å¢ ERROR è§£æ
                    level = 'error';
                    message = logMessage.substring(7).trim();
                } else if (logMessage.includes('Exception') || logMessage.includes('WARN')) {
                    level = 'error'; // æ˜ç¡®å°†å¼‚å¸¸å’Œè­¦å‘Šè§†ä¸º error çº§åˆ«
                    message = logMessage;
                }
                // --- ç»“æŸä¿®å¤ç‚¹ ---

                log(message, level);
            };

            logWebSocket.onclose = function(event) {
                if (isWebSocketConnected) {
                    isWebSocketConnected = false;
                    updateWebSocketStatus('disconnected', 'ğŸ”´ è¿æ¥æ–­å¼€');
                    log('âŒ WebSocket è¿æ¥å·²æ–­å¼€', 'info');
                    console.log('WebSocket disconnected');
                    handleReconnect();
                }
            };

            logWebSocket.onerror = function(error) {
                updateWebSocketStatus('disconnected', 'ğŸ”´ è¿æ¥é”™è¯¯');
                log('âŒ WebSocket è¿æ¥é”™è¯¯', 'error'); // ä½¿ç”¨ error çº§åˆ«
                console.error('WebSocket error:', error);
                if (logWebSocket) logWebSocket.close();
            };

        } catch (error) {
            console.error('WebSocket init error:', error);
            log('âŒ WebSocket åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error'); // ä½¿ç”¨ error çº§åˆ«
            updateWebSocketStatus('disconnected', 'ğŸ”´ è¿æ¥å¤±è´¥');
            handleReconnect();
        }
    }

    function updateWebSocketStatus(status, text) {
        const statusEl = document.getElementById('wsStatus');
        const logStatusEl = document.getElementById('logWsStatus');
        statusEl.className = 'ws-status ' + status;
        statusEl.textContent = text;
        logStatusEl.className = 'ws-status ' + status;
        logStatusEl.textContent = text;
    }

    function handleReconnect() {
        if (reconnectTimer === null && !isWebSocketConnected) {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = RECONNECT_INTERVAL * Math.min(reconnectAttempts, 3);
                log(`ğŸ”„ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} å°è¯•é‡æ–°è¿æ¥ (${delay}mså)...`, 'info');

                reconnectTimer = setTimeout(() => {
                    reconnectTimer = null;
                    initWebSocket();
                }, delay);
            } else {
                log('âŒ é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ‰‹åŠ¨é‡è¿æˆ–åˆ·æ–°é¡µé¢', 'error'); // ä½¿ç”¨ error çº§åˆ«
            }
        }
    }

    function reconnectWebSocket() {
        if (logWebSocket) {
            try {
                logWebSocket.close(1000, "User manual reconnect");
            } catch (e) { /* ignored */ }
        }
        logWebSocket = null;
        isWebSocketConnected = false;
        reconnectAttempts = 0;
        clearTimeout(reconnectTimer);
        reconnectTimer = null;

        log('æ‰‹åŠ¨é‡è¿ä¸­...', 'info');
        initWebSocket();
    }


    // ================= é…ç½®å¸¸é‡ =================
    const API_BASE = "http://localhost:8082";
    const API_URLS = {
        VALIDATE: `${API_BASE}/api/auto/validate`,
        EXECUTE: `${API_BASE}/api/auto/execute`,
        EXPORT_COOKIE: `${API_BASE}/api/auto/export-cookie`,
        GENERATE_PREVIEW: `${API_BASE}/api/code-generator/preview`,
        GENERATE_DOWNLOAD: `${API_BASE}/api/code-generator/generate`,
        SUPPORTED_LANGUAGES: `${API_BASE}/api/code-generator/supported-languages`
    };

    // ================= æ±‰åŒ–æ˜ å°„ =================
    const TYPE_LABELS = {
        "NAVIGATE": "ğŸŒ å¯¼èˆªè·³è½¬ (Navigate)",
        "INPUT": "âŒ¨ï¸ è¾“å…¥æ–‡æœ¬ (Input)",
        "CLICK": "ğŸ‘† ç‚¹å‡»å…ƒç´  (Click)",
        "SWITCH_IFRAME": "ğŸ–¼ï¸ åˆ‡æ¢ Iframe",
        "GET_CURRENT_URL": "ğŸ”— è·å–å½“å‰ URL",
        "GET_TEXT": "ğŸ“„ è·å–æ–‡æœ¬å†…å®¹",
        "PRESS_KEYS": "ğŸ¹ æŒ‰é”®æ¨¡æ‹Ÿ (Press Keys)",
        "KEYBOARD_INPUT": "ğŸ–Šï¸ é”®ç›˜ç›´æ¥è¾“å…¥",
        "WAIT": "â³ å¼ºåˆ¶ç­‰å¾…",
        "HANDLE_ALERT": "âš ï¸ å¤„ç†å¼¹çª— (Alert)",
        "IMPORT_COOKIE": "ğŸª å¯¼å…¥ Cookie",
        "CLOSE_TAB": "âŒ å…³é—­æ ‡ç­¾é¡µ",
        "GO_BACK": "â¬…ï¸ æµè§ˆå™¨åé€€",
        "LOOP_CLICK": "ğŸ” å¾ªç¯ç‚¹å‡» (Loop Click)",
        "LOOP_INPUT": "ğŸ” å¾ªç¯è¾“å…¥ (Loop Input)",
        "LOOP_GET_TEXT": "ğŸ” å¾ªç¯è·å–æ–‡æœ¬",
        "LOOP_TASK": "ğŸ”„ å¾ªç¯ä»»åŠ¡ (ç®€å•)",
        "DYNAMIC_LOOP": "ğŸ”‚ åŠ¨æ€åµŒå¥—å¾ªç¯ (Dynamic)"
    };

    const NESTABLE_TYPES = ["DYNAMIC_LOOP", "LOOP_TASK"];
    const FILE_EXTENSIONS = { 'java': '.java', 'python': '.py', 'cpp': '.cpp', 'go': '.go' };
    const LANGUAGE_DISPLAY_NAMES = {
        'java': 'Java (Selenium)',
        'python': 'Python (Selenium)',
        'cpp': 'C++ (Selenium)',
        'go': 'Go (Selenium)'
    };
    const LEVEL_TO_BADGE = {
        'info': 'INFO',
        'data': 'DATA',
        'error': 'ERROR'
    };

    let taskData = { "url": "", "steps": [] };
    let currentGeneratedCode = null;
    let currentFileName = null;
    let supportedLanguages = [];
    let logEntries = [];
    let logStats = { total: 0, info: 0, data: 0, error: 0 };
    let draggingStep = null;
    let draggingStepsList = null;

    window.addEventListener('load', function() {
        renderAll();
        loadSupportedLanguages();
        initWebSocket();
        setupLogFilters();
    });

    document.getElementById('rootUrl').addEventListener('input', (e) => taskData.url = e.target.value);

    // åœ¨é¡µé¢å…³é—­æ—¶æ¸…ç† WebSocket
    window.addEventListener('beforeunload', function() {
        if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
            logWebSocket.close(1000, "Client closed page");
        }
    });

    function setupLogFilters() {
        document.getElementById('logLevelFilter').addEventListener('change', filterLogs);
        document.getElementById('logSearch').addEventListener('input', filterLogs);
    }

    async function loadSupportedLanguages() {
        try {
            const response = await fetch(API_URLS.SUPPORTED_LANGUAGES);
            if (response.ok) {
                supportedLanguages = await response.json();
            } else {
                supportedLanguages = ['java', 'python', 'cpp', 'go'];
                log("åŠ è½½è¯­è¨€åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨", "info");
            }
        } catch (error) {
            supportedLanguages = ['java', 'python', 'cpp', 'go'];
            log("æ— æ³•è¿æ¥åç«¯ï¼Œä½¿ç”¨é»˜è®¤è¯­è¨€åˆ—è¡¨", "info");
        }

        const javaIndex = supportedLanguages.indexOf('java');
        if (javaIndex > -1) {
            supportedLanguages.splice(javaIndex, 1);
            supportedLanguages.unshift('java');
        } else if (!supportedLanguages.includes('java')) {
            supportedLanguages.unshift('java');
        }

        renderLanguageSelect();
    }

    function renderLanguageSelect() {
        const select = document.getElementById('codeLang');
        select.innerHTML = '';
        supportedLanguages.forEach(lang => {
            const option = document.createElement('option');
            option.value = lang;
            const displayName = LANGUAGE_DISPLAY_NAMES[lang] || lang.charAt(0).toUpperCase() + lang.slice(1);
            option.textContent = displayName;
            select.appendChild(option);
        });
        if(supportedLanguages.length > 0) select.value = supportedLanguages[0];
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
        if (btn) btn.classList.add('active');

        const content = document.getElementById(`tab-${tabId}`);
        if (content) content.classList.add('active');

        if (tabId === 'logs') {
            renderLogs();
        }
    }

    function renderAll() {
        const container = document.getElementById('stepsContainer');
        container.innerHTML = '';
        // æ¸²æŸ“æ ¹æ­¥éª¤
        renderSteps(taskData.steps, container, false);
        initDragAndDrop(); // é‡æ–°æ¸²æŸ“åï¼Œé‡æ–°ç»‘å®šæ‹–æ‹½äº‹ä»¶
    }

    function createField(step, label, key, placeholder, type = 'text', hint = '') {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `<label>${label}</label>`;
        const input = document.createElement('input');
        input.type = type;
        input.placeholder = placeholder || '';
        const initialValue = step[key] !== undefined ? step[key] : (type === 'number' ? 0 : '');
        input.value = initialValue;
        input.oninput = (e) => {
            const val = type === 'number' ? (parseFloat(e.target.value) || 0) : e.target.value;
            step[key] = val;
            // å¦‚æœæ˜¯å¤‡æ³¨å­—æ®µï¼Œæ›´æ–°å¤´éƒ¨æ˜¾ç¤º
            if(key === 'remark') {
                const card = e.target.closest('.step-card');
                if (card) {
                    const remarkSpan = card.querySelector('.step-header span:last-child');
                    if (remarkSpan) remarkSpan.innerText = val || '(æ— å¤‡æ³¨)';
                }
            }
        };
        div.appendChild(input);
        if(hint) {
            const hintEl = document.createElement('div');
            hintEl.style.fontSize = '0.75rem';
            hintEl.style.color = '#94a3b8';
            hintEl.style.marginTop = '4px';
            hintEl.innerText = hint;
            div.appendChild(hintEl);
        }
        return div;
    };

    function renderSteps(steps, parentElement, isNested) {
        if (!steps || steps.length === 0) return;

        steps.forEach((step, index1) => {
            const card = document.createElement('div');
            card.className = 'step-card';
            card.dataset.index = index1;
            card.dataset.listId = parentElement.id || 'nested';
            card.stepData = step;
            card.stepsList = steps;

            // --- å¤´éƒ¨ (å¯æ‹–æ‹½åŒºåŸŸ) ---
            const header = document.createElement('div');
            header.className = 'step-header';
            header.draggable = true;

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶åˆ° header
            header.addEventListener('dragstart', handleDragStart);
            header.addEventListener('dragend', handleDragEnd);


            const leftHeader = document.createElement('div');
            leftHeader.style.display = 'flex';
            leftHeader.style.alignItems = 'center';
            leftHeader.innerHTML = `<span class="step-badge">#${index1 + 1}</span>`;

            const typeSelect = document.createElement('select');
            typeSelect.style.width = '240px';
            typeSelect.style.fontWeight = 'bold';
            for (const [key, label] of Object.entries(TYPE_LABELS)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.text = label;
                if (key === step.type) opt.selected = true;
                typeSelect.appendChild(opt);
            }
            typeSelect.onchange = (e) => {
                step.type = e.target.value;
                if (NESTABLE_TYPES.includes(step.type) && !step.subSteps) step.subSteps = [];
                // å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºå­—æ®µä¼šå˜åŒ–
                renderAll();
            };
            leftHeader.appendChild(typeSelect);

            const remarkSpan = document.createElement('span');
            remarkSpan.style.marginLeft = '15px';
            remarkSpan.style.color = 'var(--text-sub)';
            remarkSpan.style.fontSize = '0.9rem';
            remarkSpan.innerText = step.remark || '(æ— å¤‡æ³¨)';
            leftHeader.appendChild(remarkSpan);
            header.appendChild(leftHeader);

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger';
            delBtn.style.padding = '4px 10px';
            delBtn.style.fontSize = '0.8rem';
            delBtn.innerText = 'åˆ é™¤';
            delBtn.onclick = () => {
                if(confirm('ç¡®å®šåˆ é™¤æ­¤æ­¥éª¤ï¼Ÿ')) {
                    steps.splice(index1, 1);
                    renderAll();
                }
            };
            header.appendChild(delBtn);
            card.appendChild(header);

            // --- è¡¨å•ç”Ÿæˆå™¨ ---
            const grid = document.createElement('div');
            grid.className = 'form-grid';

            grid.appendChild(createField(step, 'å¤‡æ³¨', 'remark', 'æè¿°æ­¤æ­¥éª¤çš„ä½œç”¨...'));

            const t = step.type;
            const elements = [];

            // --- START MODIFICATION ---
            // ç§»é™¤äº† KEYBOARD_INPUT
            const noXpathTypes = ['WAIT', 'CLOSE_TAB', 'GO_BACK', 'NAVIGATE', 'DYNAMIC_LOOP', 'IMPORT_COOKIE', 'GET_CURRENT_URL', 'HANDLE_ALERT', 'PRESS_KEYS'];
            if (!noXpathTypes.includes(t)) {
                // --- END MODIFICATION ---
                elements.push(createField(step, 'XPath / å®šä½ç¬¦', 'xpath', '//div[@id="btn"]'));

                // === å ä½ç¬¦æç¤º ===
                const needsPrompt = ['INPUT', 'CLICK', 'GET_TEXT'].includes(t) || t === 'KEYBOARD_INPUT'; // KEYBOARD_INPUT å¯èƒ½ä¼šç”¨åˆ°å ä½ç¬¦
                const isLoopType = t.startsWith('LOOP');

                if (isNested || isLoopType || needsPrompt) {
                    const hintDiv = document.createElement('div');
                    hintDiv.style.gridColumn = '1 / -1'; // è·¨åˆ—æ˜¾ç¤º
                    hintDiv.style.fontSize = '0.85rem';
                    hintDiv.style.color = 'var(--primary)';
                    hintDiv.style.backgroundColor = '#e0f2fe';
                    hintDiv.style.padding = '8px 10px';
                    hintDiv.style.borderRadius = '4px';
                    hintDiv.style.borderLeft = '3px solid var(--primary)';

                    let baseHint = 'ğŸ’¡ æç¤ºï¼šXPath/è¾“å…¥å†…å®¹ é»˜è®¤æ”¯æŒ {i}, {index} å ä½ç¬¦ã€‚';

                    if (isLoopType) {
                        baseHint += '  (å¾ªç¯æ­¥éª¤å†…ç½®, é»˜è®¤å€¼ 1) ';
                    } else if (t === 'DYNAMIC_LOOP') {
                        baseHint += '  (é»˜è®¤å€¼ 0) ';
                    } else if (needsPrompt && isNested) {
                        baseHint += ' (ä½œä¸ºå­æ­¥éª¤ï¼Œå¯ä»¥ä½¿ç”¨åŠ¨æ€å¾ªç¯çš„å ä½ç¬¦æ“ä½œå…ƒç´ )';
                    }

                    if (needsPrompt || isLoopType || t === 'DYNAMIC_LOOP') {
                        hintDiv.innerHTML = baseHint;
                        elements.push(hintDiv);
                    }
                }
                // =================================
            }

            const hasValueField = ['INPUT', 'NAVIGATE', 'LOOP_INPUT', 'DYNAMIC_LOOP', 'LOOP_TASK', 'PRESS_KEYS', 'KEYBOARD_INPUT'].includes(t) || step.value !== undefined;
            if (hasValueField) {
                let label = 'å€¼ / å‚æ•°';
                let ph = 'è¾“å…¥å€¼';
                let hint = '';

                if (t === 'NAVIGATE') { label = 'è·³è½¬ URL åœ°å€'; ph = 'https://...'; }
                else if (t === 'INPUT' || t === 'LOOP_INPUT') { label = 'è¾“å…¥å†…å®¹'; ph = 'è¦è¾“å…¥çš„æ–‡æœ¬'; }
                else if (t === 'PRESS_KEYS') { label = 'æŒ‰é”®ç»„åˆ'; ph = 'ä¾‹å¦‚ï¼šCTRL+A (å…¨é€‰)'; hint = 'æ”¯æŒç»„åˆé”®ï¼Œå¦‚ CONTROL, ALT, SHIFT'; }
                else if (t === 'KEYBOARD_INPUT') { label = 'è¾“å…¥å†…å®¹'; ph = 'ç›´æ¥æ•²å‡»é”®ç›˜çš„å†…å®¹'; hint = 'å¯ä»¥ç©¿æ’æŒ‰é”®ä»£ç ï¼Œå¦‚ï¼šHello{ENTER}World. **éœ€è¦XPathæŒ‡å®šè¾“å…¥æ¡†**'; } // æç¤º XPath éœ€æ±‚

                elements.push(createField(step, label, 'value', ph, 'text', hint));
            }

            if (t === 'HANDLE_ALERT') {
                elements.push(createField(step, 'è¾“å…¥å¼¹çª—æ–‡æœ¬ (å¯é€‰)', 'alertText', 'è‹¥å¼¹çª—éœ€è¦è¾“å…¥ï¼Œè¯·å¡«å†™'));

                const divAlert = document.createElement('div');
                divAlert.className = 'form-group';
                divAlert.innerHTML = `<label>å¤„ç†æ–¹å¼</label>`;
                const sel = document.createElement('select');
                const optYes = document.createElement('option'); optYes.value = 'true'; optYes.text = 'ç¡®è®¤ / æ¥å— (Accept)';
                const optNo = document.createElement('option'); optNo.value = 'false'; optNo.text = 'å–æ¶ˆ / æ‹’ç» (Dismiss)';

                if (step.acceptAlert === false || step.acceptAlert === 'false') {
                    optNo.selected = true;
                    step.acceptAlert = false;
                } else {
                    optYes.selected = true;
                    step.acceptAlert = true;
                }

                sel.appendChild(optYes);
                sel.appendChild(optNo);
                sel.onchange = (e) => { step.acceptAlert = (e.target.value === 'true'); };
                divAlert.appendChild(sel);
                elements.push(divAlert);
            }

            if (t === 'IMPORT_COOKIE') {
                elements.push(createField(step, 'Cookie æ–‡ä»¶è·¯å¾„', 'filePath', 'C:/cookies.txt'));
            }

            if (t === 'LOOP_GET_TEXT') {
                elements.push(createField(step, 'è¾“å‡ºæ–‡ä»¶è·¯å¾„', 'filePath', 'output/text_list.txt', 'text', 'æŠ“å–çš„æ–‡æœ¬å°†è¿½åŠ å†™å…¥æ­¤æ–‡ä»¶'));
            }

            const isLoop = t.startsWith('LOOP') || t === 'DYNAMIC_LOOP';
            if (isLoop) {
                if (['DYNAMIC_LOOP', 'LOOP_TASK'].includes(t)) {
                    if (step.iterations === undefined) step.iterations = 3;
                    elements.push(createField(step, 'å¾ªç¯æ¬¡æ•°', 'iterations', '3', 'number'));
                } else {
                    if (step.startIndex === undefined) step.startIndex = 1;
                    if (step.endIndex === undefined) step.endIndex = 5;
                    elements.push(createField(step, 'èµ·å§‹ç´¢å¼•', 'startIndex', '1', 'number'));
                    elements.push(createField(step, 'ç»“æŸç´¢å¼•', 'endIndex', '5', 'number'));
                }
            }

            // ç¡®ä¿ waitBeforeMs å’Œ waitAfterMs å®šä¹‰
            if (step.waitBeforeMs === undefined) step.waitBeforeMs = 0;
            if (step.waitAfterMs === undefined) step.waitAfterMs = 500;

            // å°†ç­‰å¾…æ—¶é—´æ”¾åœ¨æœ€å
            elements.push(createField(step, 'å‰ç½®ç­‰å¾…(ms)', 'waitBeforeMs', '0', 'number'));
            elements.push(createField(step, 'åç½®ç­‰å¾…(ms)', 'waitAfterMs', '500', 'number'));

            elements.forEach(el => grid.appendChild(el));

            card.appendChild(grid);

            // --- åµŒå¥—å­æ­¥éª¤ ---
            if (NESTABLE_TYPES.includes(t)) {
                const nestedArea = document.createElement('div');
                nestedArea.className = 'nested-area';

                //  æ‹–æ‹½ï¼šè®¾ç½® nestedArea ä¸ºæ‹–æ”¾ç›®æ ‡å®¹å™¨
                nestedArea.stepsList = step.subSteps;
                nestedArea.classList.add('steps-list');
                nestedArea.addEventListener('dragover', handleDragOver);
                nestedArea.addEventListener('dragleave', handleDragLeave);
                nestedArea.addEventListener('drop', handleDrop);


                const nestedHead = document.createElement('div');
                nestedHead.style.display = 'flex';
                nestedHead.style.justifyContent = 'space-between';
                nestedHead.style.marginBottom = '10px';
                nestedHead.innerHTML = `<strong style="color:var(--primary)">å­ä»»åŠ¡æµç¨‹</strong>`;

                const addSub = document.createElement('button');
                addSub.className = 'btn btn-secondary';
                addSub.style.fontSize = '0.8rem';
                addSub.style.padding = '4px 10px';
                addSub.innerText = '+ æ·»åŠ å­æ­¥éª¤';
                addSub.onclick = () => {
                    if (!step.subSteps) step.subSteps = [];
                    step.subSteps.push({ type: 'CLICK', waitBeforeMs: 0, waitAfterMs: 500, remark: 'å­æ“ä½œ' });
                    renderAll();
                };
                nestedHead.appendChild(addSub);
                nestedArea.appendChild(nestedHead);

                if (step.subSteps && step.subSteps.length > 0) {
                    renderSteps(step.subSteps, nestedArea, true); // é€’å½’è°ƒç”¨ï¼Œè®¾ç½® isNested ä¸º true
                } else {
                    const tip = document.createElement('div');
                    tip.style.color = '#94a3b8';
                    tip.style.textAlign = 'center';
                    tip.innerText = 'æš‚æ— å­æ­¥éª¤';
                    nestedArea.appendChild(tip);
                }
                card.appendChild(nestedArea);
            }

            parentElement.appendChild(card);
        });
    }

    //  æ–°å¢/æ›´æ–°ï¼šæ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–
    function initDragAndDrop() {
        const rootContainer = document.getElementById('stepsContainer');
        rootContainer.classList.add('steps-list');

        // ç¡®ä¿æ ¹å®¹å™¨ä¹Ÿæ˜¯æ‹–æ”¾ç›®æ ‡
        rootContainer.addEventListener('dragover', handleDragOver);
        rootContainer.addEventListener('dragleave', handleDragLeave);
        rootContainer.addEventListener('drop', handleDrop);
        rootContainer.stepsList = taskData.steps;

    }

    function handleDragStart(e) {
        const header = e.currentTarget;
        const card = header.closest('.step-card');

        if (!card) return;

        draggingStep = card.stepData;
        draggingStepsList = card.stepsList;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', card.dataset.index);
        card.classList.add('dragging');

        const dragImg = document.createElement('div');
        dragImg.style.width = '1px';
        dragImg.style.height = '1px';
        e.dataTransfer.setDragImage(dragImg, 0, 0);
    }

    function handleDragEnd(e) {
        document.querySelectorAll('.step-card').forEach(c => c.classList.remove('dragging'));
        document.querySelectorAll('.drag-over-indicator').forEach(i => i.remove());
        draggingStep = null;
        draggingStepsList = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        if (!e.target.closest('.steps-list') || !draggingStep) return;

        const container = e.currentTarget;
        e.dataTransfer.dropEffect = 'move';

        // ç§»é™¤æ—§çš„æŒ‡ç¤ºå™¨
        container.querySelectorAll('.drag-over-indicator').forEach(i => i.remove());

        // æŸ¥æ‰¾æœ€æ¥è¿‘çš„æ­¥éª¤å¡ç‰‡
        const afterElement = getDragAfterElement(container, e.clientY);

        // åˆ›å»ºæ–°çš„æŒ‡ç¤ºå™¨
        const indicator = document.createElement('div');
        indicator.className = 'drag-over-indicator';

        if (afterElement == null) {
            // æ”¾ç½®åœ¨åˆ—è¡¨æœ«å°¾
            container.appendChild(indicator);
        } else if (afterElement.classList.contains('step-card')) {
            // æ”¾ç½®åœ¨æŸä¸ªå¡ç‰‡ä¹‹å‰
            container.insertBefore(indicator, afterElement);
        } else if (container.id === 'stepsContainer' || container.classList.contains('nested-area')) {
            // æ”¾ç½®åœ¨ç©ºå®¹å™¨æˆ–åµŒå¥—åŒºçš„å¤´éƒ¨ (afterElementä¸ºnull)
            const firstCard = Array.from(container.children).find(c => c.classList.contains('step-card'));
            if (firstCard) {
                container.insertBefore(indicator, firstCard);
            } else {
                const nestedHead = container.querySelector('strong');
                if(nestedHead && nestedHead.parentNode) {
                    container.appendChild(indicator);
                } else {
                    container.appendChild(indicator);
                }
            }
        }
    }

    function handleDragLeave(e) {
        e.currentTarget.querySelectorAll('.drag-over-indicator').forEach(i => i.remove());
    }

    function handleDrop(e) {
        e.preventDefault();
        const dropTarget = e.currentTarget;
        dropTarget.querySelectorAll('.drag-over-indicator').forEach(i => i.remove());

        if (!draggingStep) return;

        const currentList = draggingStepsList;
        const targetList = dropTarget.stepsList || taskData.steps;

        const oldIndex = currentList.indexOf(draggingStep);
        let newIndex = -1;

        // ç¡®å®šæ”¾ç½®ä½ç½®
        const afterElement = getDragAfterElement(dropTarget, e.clientY);

        // å¦‚æœæ‹–æ‹½çš„æ˜¯åµŒå¥—æ­¥éª¤åˆ°æ ¹æ­¥éª¤ï¼Œæˆ–åä¹‹ï¼Œéœ€è¦è¿›è¡Œæ•°ç»„é—´çš„ç§»åŠ¨ã€‚
        if (currentList !== targetList) {
            // 1. ä»åŸæ•°ç»„ç§»é™¤
            currentList.splice(oldIndex, 1);
            log(`æ­¥éª¤ [${draggingStep.remark}] ä»åŸåˆ—è¡¨ç§»é™¤`, 'info');

            // 2. ç¡®å®šæ–°ç´¢å¼•
            // éœ€è¦è¿‡æ»¤å‡ºå±äºç›®æ ‡æ•°ç»„çš„æ­¥éª¤å¡ç‰‡
            const cards = Array.from(dropTarget.querySelectorAll('.step-card')).filter(c => c.stepsList === targetList);
            if (afterElement === null) {
                newIndex = targetList.length; // æ”¾åœ¨æœ«å°¾
            } else {
                // ç¡®ä¿ afterElement æ˜¯ç›®æ ‡åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå¡ç‰‡
                const targetCard = afterElement.closest('.step-card');
                if (targetCard && targetCard.stepsList === targetList) {
                    newIndex = targetList.indexOf(targetCard.stepData);
                } else {
                    newIndex = targetList.length; // æ‰¾ä¸åˆ°ç›®æ ‡å¡ç‰‡ï¼Œé»˜è®¤æœ«å°¾
                }
            }

            // 3. æ’å…¥åˆ°æ–°æ•°ç»„
            targetList.splice(newIndex, 0, draggingStep);
            log(`æ­¥éª¤ [${draggingStep.remark}] ç§»åŠ¨åˆ°æ–°åˆ—è¡¨ç´¢å¼• ${newIndex}`, 'info');

        } else {
            // æ•°ç»„å†…ç§»åŠ¨
            if (afterElement === null) {
                newIndex = currentList.length - 1; // æ”¾åœ¨æœ«å°¾
            } else {
                const targetCard = afterElement.closest('.step-card');
                newIndex = currentList.indexOf(targetCard.stepData);
            }

            // æ‰§è¡Œæ•°ç»„ç§»åŠ¨æ“ä½œ
            if (oldIndex < newIndex) {
                newIndex--; // å¦‚æœæ˜¯ä»ä¸Šå¾€ä¸‹æ‹–ï¼Œç›®æ ‡ç´¢å¼•éœ€è¦å‡1
            }

            // åªæœ‰å½“ä½ç½®ç¡®å®å‘ç”Ÿå˜åŒ–æ—¶æ‰æ“ä½œæ•°ç»„
            if (oldIndex !== newIndex) {
                const [removed] = currentList.splice(oldIndex, 1);
                currentList.splice(newIndex, 0, removed);
                log(`æ­¥éª¤ [${removed.remark}] ç§»åŠ¨åˆ°ç´¢å¼• ${newIndex}`, 'info');
            }
        }

        // é‡æ–°æ¸²æŸ“æ•´ä¸ªæ­¥éª¤åˆ—è¡¨ä»¥åŒæ­¥æ•°æ®å’Œç•Œé¢
        renderAll();
    }

    // æŸ¥æ‰¾æ‹–æ‹½ä½ç½®åé¢çš„å…ƒç´ 
    function getDragAfterElement(container, y) {
        // æŸ¥æ‰¾æ‰€æœ‰éæ‹–æ‹½ä¸­çš„æ­¥éª¤å¡ç‰‡
        const draggableElements = Array.from(container.querySelectorAll('.step-card:not(.dragging)'));

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    function addRootStep() {
        taskData.steps.push({
            type: 'WAIT',
            waitBeforeMs: 0,
            waitAfterMs: 1000,
            remark: 'æ–°æ­¥éª¤'
        });
        renderAll();
        setTimeout(() => {
            const container = document.getElementById('stepsContainer');
            container.lastElementChild?.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }


    function exportJson() {
        taskData.url = document.getElementById('rootUrl').value;
        const fileNameInput = document.getElementById('exportFileName').value.trim();
        const fileName = fileNameInput ? fileNameInput : `auto_config_${Date.now()}`;

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(taskData, null, 2));
        const anchor = document.createElement('a');
        anchor.href = dataStr;
        anchor.download = `${fileName}.json`;
        anchor.click();
        log(`å·²å¯¼å‡ºé…ç½®æ–‡ä»¶: ${fileName}.json`, "info");
    }

    function triggerImport() { document.getElementById('fileInput').click(); }

    function handleFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json.steps)) {
                    taskData = json;
                    document.getElementById('rootUrl').value = taskData.url || '';
                    renderAll();
                    showToast('âœ… å¯¼å…¥æˆåŠŸ', 'success');
                    log("æˆåŠŸå¯¼å…¥ JSON é…ç½®", "info");
                } else {
                    showToast('âŒ JSON æ ¼å¼é”™è¯¯', 'error');
                    log("å¯¼å…¥å¤±è´¥: JSON ç¼ºå°‘ steps æ•°ç»„", "error");
                }
            } catch (err) {
                showToast('âŒ è§£æå¤±è´¥', 'error');
                log(`å¯¼å…¥å¤±è´¥: ${err.message}`, "error");
            }
            input.value = '';
        };
        reader.readAsText(file);
    }


    async function validateSteps() {
        log("å¼€å§‹æ ¡éªŒæµç¨‹...", "info");
        await sendTaskRequest(API_URLS.VALIDATE, "æ ¡éªŒ");
    }

    async function executeSteps() {
        if(!confirm("âš ï¸ ç¡®å®šè¦å¼€å§‹æ‰§è¡Œä»»åŠ¡å—ï¼Ÿæµè§ˆå™¨å°†è‡ªåŠ¨æ“ä½œã€‚")) return;

        if (!isWebSocketConnected) {
            log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œå°†æ— æ³•æ¥æ”¶å®æ—¶æ—¥å¿—', 'warning');
            if (!confirm('å®æ—¶æ—¥å¿—è¿æ¥å¼‚å¸¸ï¼Œæ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Ÿ')) return;
        }

        log("ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...", "info");
        await sendTaskRequest(API_URLS.EXECUTE, "æ‰§è¡Œ");
    }

    async function sendTaskRequest(url, actionName) {
        taskData.url = document.getElementById('rootUrl').value;
        if (!taskData.url) {
            log("é”™è¯¯: æœªå¡«å†™èµ·å§‹ URL", "error");
            return showToast('è¯·å¡«å†™èµ·å§‹ URL', 'error');
        }
        if (taskData.steps.length === 0) {
            log("é”™è¯¯: æ­¥éª¤åˆ—è¡¨ä¸ºç©º", "error");
            return showToast('æ­¥éª¤ä¸èƒ½ä¸ºç©º', 'error');
        }

        showToast(`â³ æ­£åœ¨${actionName}...`, 'primary', 2000);

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });
            const text = await res.text();

            if (res.ok) {
                showToast(`âœ… ${actionName}æˆåŠŸ`, 'success');
                log(`${actionName}æˆåŠŸ! åç«¯å“åº”:\n${text}`, "info");
            } else {
                showToast(`âŒ ${actionName}å¤±è´¥`, 'error');
                log(`${actionName}å¤±è´¥! é”™è¯¯ä¿¡æ¯:\n${text}`, "error");
            }
        } catch (e) {
            showToast(`ç½‘ç»œè¯·æ±‚å¼‚å¸¸`, 'error');
            log(`è¯·æ±‚å¼‚å¸¸: ${e.message}`, "error");
        }
    }


    async function exportCookie() {
        const urlVal = document.getElementById('cookieUrl').value.trim();
        const waitVal = document.getElementById('cookieWait').value;
        const pathVal = document.getElementById('cookiePath').value.trim();

        if (!urlVal || !waitVal || !pathVal) {
            showToast('âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }

        if (!isWebSocketConnected) {
            log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œå°†æ— æ³•æ¥æ”¶å®æ—¶æ—¥å¿—', 'warning');
            if (!confirm('å®æ—¶æ—¥å¿—è¿æ¥å¼‚å¸¸ï¼Œæ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Ÿ')) return;
        }

        const req = {
            url: urlVal,
            waitSeconds: parseInt(waitVal),
            filePath: pathVal
        };

        showToast('â³ æ­£åœ¨å¯åŠ¨æµè§ˆå™¨æå– Cookie...', 'primary', 5000);
        log(`å¯åŠ¨ Cookie æå–ä»»åŠ¡: ç›®æ ‡=${urlVal}, ç­‰å¾…=${waitVal}s, è·¯å¾„=${pathVal}`, "info");

        try {
            const res = await fetch(API_URLS.EXPORT_COOKIE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(req)
            });
            const text = await res.text();
            if (res.ok) {
                showToast(`âœ… Cookie å¯¼å‡ºæˆåŠŸ!`, 'success');
                log(`Cookie å¯¼å‡ºæˆåŠŸ: ${text}`, "info");
            } else {
                showToast(`âŒ å¯¼å‡ºå¤±è´¥: ${text}`, 'error');
                log(`Cookie å¯¼å‡ºå¤±è´¥: ${text}`, "error");
            }
        } catch (e) {
            showToast(`ç½‘ç»œé”™è¯¯`, 'error');
            log(`Cookie ä»»åŠ¡å¼‚å¸¸: ${e.message}`, "error");
        }
    }


    async function generateCodePreview() {
        if (taskData.steps.length === 0) return showToast('è¯·å…ˆåœ¨"æµç¨‹ç¼–æ’"ä¸­æ·»åŠ æ­¥éª¤', 'error');
        const lang = document.getElementById('codeLang').value;
        if (!lang) return showToast('è¯·é€‰æ‹©ç¼–ç¨‹è¯­è¨€', 'error');

        const req = {
            language: lang,
            steps: taskData.steps,
            initialUrl: document.getElementById('rootUrl').value || "https://example.com",
            className: document.getElementById('codeClassName').value || "AutoTask",
            includeComments: document.getElementById('codeComments').checked
        };

        showToast('â³ ç”Ÿæˆä»£ç ä¸­...', 'primary');
        log(`æ­£åœ¨ç”Ÿæˆ ${lang} ä»£ç é¢„è§ˆ...`, "info");

        try {
            const res = await fetch(API_URLS.GENERATE_PREVIEW, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(req)
            });

            if (res.ok) {
                const codeText = await res.text();
                currentGeneratedCode = codeText;
                currentFileName = `${req.className}${FILE_EXTENSIONS[lang] || '.txt'}`;

                document.getElementById('codePreview').textContent = codeText;
                document.getElementById('fileNameInfo').textContent = `æ–‡ä»¶å: ${currentFileName}`;
                document.getElementById('fileSizeInfo').textContent = ` | å¤§å°: ${(codeText.length / 1024).toFixed(2)} KB`;
                document.getElementById('languageInfo').textContent = ` | è¯­è¨€: ${lang.toUpperCase()}`;

                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('codeActions').style.display = 'flex';
                showToast('âœ… ä»£ç ç”ŸæˆæˆåŠŸ', 'success');
                log("ä»£ç é¢„è§ˆç”Ÿæˆå®Œæ¯•", "info");
            } else {
                const err = await res.text();
                showToast(`âŒ ç”Ÿæˆå¤±è´¥`, 'error');
                log(`ä»£ç ç”Ÿæˆå¤±è´¥: ${err}`, "error");
            }
        } catch (e) {
            log(`è¯·æ±‚é”™è¯¯: ${e.message}`, "error");
        }
    }

    async function downloadCode() {
        if (!currentGeneratedCode) return showToast('è¯·å…ˆç”Ÿæˆä»£ç é¢„è§ˆ', 'error');
        const lang = document.getElementById('codeLang').value;
        const req = {
            language: lang,
            steps: taskData.steps,
            initialUrl: document.getElementById('rootUrl').value || "https://example.com",
            className: document.getElementById('codeClassName').value || "AutoTask",
            includeComments: document.getElementById('codeComments').checked
        };

        try {
            const res = await fetch(API_URLS.GENERATE_DOWNLOAD, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(req)
            });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFileName;
                a.click();
                window.URL.revokeObjectURL(url);
                log(`æºç æ–‡ä»¶ä¸‹è½½æˆåŠŸ: ${currentFileName}`, "info");
            } else {
                const err = await res.text();
                log(`ä¸‹è½½è¯·æ±‚å¤±è´¥: ${err}`, "error");
            }
        } catch (e) { log(`ä¸‹è½½å¤±è´¥: ${e.message}`, "error"); }
    }

    function copyCode() {
        if (!currentGeneratedCode) return;
        navigator.clipboard.writeText(currentGeneratedCode).then(() => {
            showToast('âœ… å·²å¤åˆ¶', 'success');
        });
    }


    function log(message, level = 'info') {
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;

        const logEntry = {
            id: Date.now() + Math.random(),
            time: timeStr,
            message: message,
            level: level,
            timestamp: now.getTime()
        };

        logEntries.push(logEntry);

        updateLogStats(level);

        // åªæœ‰å½“æ—¥å¿—æ ‡ç­¾é¡µæ˜¯æ¿€æ´»çŠ¶æ€æ—¶æ‰å®æ—¶æ¸²æŸ“ï¼Œå¦åˆ™åªæ›´æ–°æ•°æ®
        if (document.getElementById('tab-logs').classList.contains('active')) {
            renderLogs();
        }

        const consoleFunc = level === 'data' ? console.warn : (level === 'error' ? console.error : console.log);
        consoleFunc(`[${level.toUpperCase()}] ${timeStr}: ${message}`);
    }

    function renderLogs() {
        const content = document.getElementById('logContent');
        const levelFilter = document.getElementById('logLevelFilter').value;
        const searchTerm = document.getElementById('logSearch').value.toLowerCase();

        //  æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼ŒåŒ…å« ERROR
        document.getElementById('logTotal').textContent = `æ€»è®¡: ${logStats.total} æ¡`;
        document.getElementById('logInfo').textContent = `ä¿¡æ¯ (INFO): ${logStats.info} æ¡`;
        document.getElementById('logData').textContent = `æ•°æ® (DATA): ${logStats.data} æ¡`;
        document.getElementById('logError').textContent = `é”™è¯¯ (ERROR): ${logStats.error} æ¡`;

        const filteredLogs = logEntries.filter(entry => {
            const levelMatch = levelFilter === 'all' || entry.level === levelFilter;
            const searchMatch = !searchTerm ||
                entry.message.toLowerCase().includes(searchTerm) ||
                entry.time.includes(searchTerm);
            return levelMatch && searchMatch;
        });

        content.innerHTML = '';
        filteredLogs.forEach(entry => {
            const entryEl = document.createElement('div');
            entryEl.className = `log-entry ${entry.level}`;

            const timeSpan = `<span class="time">${entry.time}</span>`;
            const badge = `<span class="log-level-badge">${LEVEL_TO_BADGE[entry.level] || entry.level.toUpperCase()}</span>`;

            const messageBody = `<span class="log-message">${entry.message.replace(/\n/g, '<br>')}</span>`;

            entryEl.innerHTML = `${timeSpan}${badge}${messageBody}`;
            content.appendChild(entryEl);
        });

        content.scrollTop = content.scrollHeight;
    }

    function updateLogStats(level) {
        logStats.total++;
        if (logStats.hasOwnProperty(level)) {
            logStats[level]++;
        }
    }

    function filterLogs() {
        renderLogs();
    }

    function clearLog() {
        logEntries = [];
        // æ¸…ç©º logStats æ—¶åŒ…å« error
        logStats = { total: 0, info: 0, data: 0, error: 0 };
        renderLogs();
        log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    function exportLogs() {
        if (logEntries.length === 0) {
            showToast('æ²¡æœ‰æ—¥å¿—å¯å¯¼å‡º', 'warning');
            return;
        }

        let logText = "è‡ªåŠ¨åŒ–æ§åˆ¶å°ç³»ç»Ÿæ—¥å¿—å¯¼å‡º\n";
        logText += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
        logText += `æ—¥å¿—æ€»æ•°: ${logStats.total} (ä¿¡æ¯:${logStats.info} æ•°æ®:${logStats.data} é”™è¯¯:${logStats.error})\n\n`;

        logEntries.forEach(entry => {
            logText += `[${entry.time}] [${entry.level.toUpperCase()}] ${entry.message}\n`;
        });

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `automation_logs_${Date.now()}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);

        log(`æ—¥å¿—å·²å¯¼å‡ºï¼Œå…± ${logEntries.length} æ¡è®°å½•`, "info");
    }

    function showToast(msg, type = 'primary', duration = 3000) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        let bg = 'var(--primary)';
        if(type === 'success') bg = 'var(--success)';
        if(type === 'error') bg = 'var(--danger)';
        if(type === 'warning') bg = 'var(--warning)';
        t.style.backgroundColor = bg;
        if (duration > 0) setTimeout(() => t.style.display = 'none', duration);
    }
</script>
</body>
</html>